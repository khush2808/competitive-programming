#!/bin/bash

# Script to make individual commits for each changed file
# Usage: ./make-commits [commit_message_prefix]
# If no prefix is provided, uses "Update" as default

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "Error: Not in a git repository"
    exit 1
fi

# Get the commit message prefix
PREFIX=${1:-"Update"}

# Get the list of changed files
CHANGED_FILES=$(git status --porcelain | awk '{print $2}')

if [ -z "$CHANGED_FILES" ]; then
    echo "No changed files to commit"
    exit 0
fi

echo "Found changed files:"
echo "$CHANGED_FILES"
echo

# Counter for commits made
COMMIT_COUNT=0

# Process each file
echo "$CHANGED_FILES" | while read -r FILE; do
    if [ -n "$FILE" ]; then
        echo "Processing: $FILE"

        # Stage the specific file
        if git add "$FILE"; then
            echo "  Staged: $FILE"

            # Create commit message
            COMMIT_MSG="$PREFIX $FILE"

            # Make the commit
            if git commit -m "$COMMIT_MSG"; then
                echo "  Committed: $COMMIT_MSG"
                ((COMMIT_COUNT++))
            else
                echo "  Error: Failed to commit $FILE"
            fi
        else
            echo "  Error: Failed to stage $FILE"
        fi
        echo
    fi
done

echo "Total commits made: $COMMIT_COUNT"
